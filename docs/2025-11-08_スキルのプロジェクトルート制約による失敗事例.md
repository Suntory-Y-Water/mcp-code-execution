# mcp-code-executionスキルのプロジェクトルート制約による失敗事例

## 発生日時

2025年11月8日

## 概要

`mcp-code-execution`スキルを使用して親プロジェクトの`parser`フォルダを解析しようとしたが、スキルのプロジェクトルート制約により解析対象が見つからず失敗した。

## 発生状況

### ユーザーの要求

> Serenaを使ってparserフォルダで実施しているドメイン固有処理を説明して。大規模だからRead Writeより適切だ

### 実行環境

- **スキルの実行ディレクトリ**: `/Users/user/dev/obsidian-plugin/.claude/skills/mcp-code-execution`
- **解析対象ディレクトリ**: `/Users/user/dev/obsidian-plugin/parser`
- **Serenaが認識したプロジェクトルート**: `/Users/user/dev/obsidian-plugin/.claude/skills/mcp-code-execution`

### 実行したコード

```typescript
// /Users/user/dev/obsidian-plugin/.claude/skills/mcp-code-execution/src/analyze-parser.ts
import { listDir, getSymbolsOverview, findSymbol, searchForPattern } from '../servers/serena/index.js';
import { closeClient } from './client.js';

async function main() {
  try {
    const parserDirResult = await listDir({ relative_path: 'parser', recursive: true });
    const tsFiles = (parserDirResult as any).files.filter((f: string) => f.endsWith('.ts'));
    // ...
  } catch (error) {
    // ...
  } finally {
    await closeClient();
  }
}

main();
```

### エラー内容

```
INFO  2025-11-08 14:45:10,215 [Task-2:ListDirTool] serena.tools.tools_base:task:278 - Result: {"error": "Directory not found: parser", "project_root": "/Users/user/dev/obsidian-plugin/.claude/skills/mcp-code-execution", "hint": "Check if the path is correct relative to the project root"}

エラー: undefined is not an object (evaluating '(await listDir({ relative_path: "parser", recursive: !0 })).files.filter')
```

## 原因分析

### 根本原因

mcp-code-executionスキルは**実行ディレクトリ自体をプロジェクトルートとして動作する**仕様になっている。

### ディレクトリ構造の整理

```
/Users/user/dev/obsidian-plugin/
├── .claude/
│   └── skills/
│       └── mcp-code-execution/  ← スキル実行ディレクトリ（Serenaのプロジェクトルート）
│           ├── src/
│           │   └── analyze-parser.ts
│           └── servers/
│               └── serena/
└── parser/  ← 解析したい対象ディレクトリ（スキルからは見えない）
    ├── file1.ts
    └── file2.ts
```

### なぜ失敗したのか

1. **スキルの動作仕様**
   - mcp-code-executionスキルは、スキル自身のディレクトリ（`.claude/skills/mcp-code-execution`）をプロジェクトルートとして初期化される
   - Serenaログに明示されている: `"project_root": "/Users/user/dev/obsidian-plugin/.claude/skills/mcp-code-execution"`

2. **相対パス解決の問題**
   - `listDir({ relative_path: 'parser' })`は、プロジェクトルートからの相対パスとして解釈される
   - つまり、`/Users/user/dev/obsidian-plugin/.claude/skills/mcp-code-execution/parser`を探す
   - しかし実際には存在しない（実際のparserは2階層上にある）

3. **アクセス範囲の制約**
   - スキルは自身のディレクトリ配下のファイルのみを操作対象とする
   - 親プロジェクトのファイルには直接アクセスできない設計

## 期待していた動作 vs 実際の動作

### 期待していた動作

- `parser`フォルダ = `/Users/user/dev/obsidian-plugin/parser`を解析
- parserフォルダ内のすべてのTypeScriptファイルのシンボル情報を取得
- ドメイン固有処理を抽出して報告

### 実際の動作

- `parser`フォルダ = `/Users/user/dev/obsidian-plugin/.claude/skills/mcp-code-execution/parser`を検索
- ディレクトリが見つからずエラー
- 解析処理が一切実行されなかった

## 失敗に至るまでの経緯

### タイムライン

1. **スキル起動**: mcp-code-executionスキルを起動
2. **スクリプト作成**: `src/analyze-parser.ts`を作成
3. **依存関係インストール**: `bun install`で必要なパッケージをインストール
4. **最初の実行エラー**: `readFile`ツールが存在しない（修正済み）
5. **型エラー修正**: `pattern` → `substring_pattern`に修正
6. **最終実行**: プロジェクトルートの問題で失敗

### 途中での誤った判断

- スキルのドキュメントには「100個以上のファイルを処理する場合」と記載されていた
- しかし、**どこのファイルを処理するか**については十分に確認しなかった
- スキルの動作範囲（プロジェクトルート）を事前に確認すべきだった

## 正しいアプローチ

### このタスクに適切な方法

mcp-code-executionスキルではなく、**標準ツール（Read, Grep, Glob）を使用する**のが正解。

理由:
- 解析対象は親プロジェクトのファイル
- スキルは自身のディレクトリ内のファイルしか扱えない
- 探索的な作業であり、スキルの「使用すべきでない場合」に該当

### 代替実装例

```typescript
// 標準ツールを使った実装（Claude Codeの通常機能）
// 1. parserフォルダ内のファイルを検索
await Glob({ pattern: "parser/**/*.ts" })

// 2. 各ファイルを読み込んで解析
await Read({ file_path: "/Users/.../parser/file1.ts" })

// 3. コード内のパターンを検索
await Grep({ pattern: "parse|transform|validate", path: "parser" })
```

## mcp-code-executionスキルの適切な使用例

### 使用すべき場合

1. **スキル自身のコードを操作する場合**
   - 例: `.claude/skills/mcp-code-execution/src/`配下のファイルをリファクタリング
   - 例: スキル内の100個以上のファイルに対してバッチ処理

2. **プロジェクトルートを明示的に切り替える場合**
   - Serenaの`activate_project`ツールで別プロジェクトをアクティブ化
   - ただし、これには事前の設定が必要

### 使用すべきでない場合（今回のケース）

1. **親プロジェクトのファイルを解析する場合**
2. **探索的な作業（どのファイルが重要か判断する必要がある場合）**
3. **中間結果を確認しながら進める対話的な作業**

## 学んだ教訓

### スキル使用前の確認事項

1. **プロジェクトルートの確認**
   - スキルがどのディレクトリをルートとして動作するか
   - 解析対象がそのルート配下にあるか

2. **スキルの適用範囲の理解**
   - スキルが操作できるファイルの範囲
   - 親ディレクトリへのアクセス可否

3. **タスクの性質の見極め**
   - 大規模バッチ処理なのか
   - 探索的な作業なのか
   - どちらに該当するかで使用ツールを選択

### 今後の改善策

1. **スキル起動直後にプロジェクトルートを確認する**
   - Serenaログの`project_root`を必ず確認
   - 解析対象が範囲内にあるか検証

2. **ディレクトリ構造を理解してから実装する**
   - `ls`や`listDir`でまず構造を把握
   - その上でスクリプトを作成

3. **失敗したら早期に方針転換する**
   - スキルが適切でないと判明したら、標準ツールに切り替える
   - 無理にスキルを使い続けない

## 関連ドキュメント

- mcp-code-executionスキルの仕様: `/Users/user/dev/obsidian-plugin/.claude/skills/mcp-code-execution/README.md`
- Serena MCPの動作仕様: Serenaログ出力
- Claude Codeの標準ツール: Read, Write, Grep, Glob

## まとめ

mcp-code-executionスキルは**スキル自身のディレクトリ内のファイル操作に特化**しており、親プロジェクトのファイルを直接操作することはできない。今回のような親プロジェクトの探索的な解析には、標準ツール（Read, Grep, Glob）を使用するのが適切である。
